# HeLiPR Training -> KITTI Validation Configuration
# Cross-sensor generalization: VLP-16 (HeLiPR) -> HDL-64E (KITTI)

# Data settings
data:
  lazy_load: true
  cache_dir: data/preprocessed

  # Multi-dataset configuration
  datasets:
    # Training: HeLiPR sequences (VLP-16)
    train:
      - type: helipr
        root: /workspace/data/helipr
        sequences:
          # Town (Urban environment)
          - 'Town01'
          - 'Town02'
          - 'Town03'
          # Roundabout (Highway/intersection)
          - 'Roundabout01'
          - 'Roundabout02'
          - 'Roundabout03'
          # Bridge (Structural diversity)
          - 'Bridge01'
          - 'Bridge02'
          - 'Bridge03'
          - 'Bridge04'
          # KAIST (Campus environment)
          - 'KAIST04'
          - 'KAIST05'
          - 'KAIST06'
          # DCC (Commercial district)
          - 'DCC04'
          - 'DCC05'
          - 'DCC06'
          # Riverside (Natural environment)
          - 'Riverside04'
          - 'Riverside05'
          - 'Riverside06'
        weight: 1.0

    # Validation: KITTI sequence 09 (HDL-64E)
    val:
      - type: kitti
        root: /workspace/data/kitti/dataset
        sequences: ['09']
        weight: 1.0

    # Test: KITTI sequence 10 (HDL-64E)
    test:
      - type: kitti
        root: /workspace/data/kitti/dataset
        sequences: ['10']
        weight: 1.0

# Encoding settings - Sensor-agnostic configuration
encoding:
  # VLP-16 native (HeLiPR training sensor)
  n_elevation: 16
  n_azimuth: 360
  elevation_range: [-15.0, 15.0]  # VLP-16 FOV
  max_range: 80.0
  min_range: 1.0

  # Sensor-agnostic normalization (CRITICAL for cross-sensor!)
  target_elevation_bins: 16  # Normalize all sensors to 16 bins

  # Spectral histogram
  n_bins: 50
  alpha: 2.0
  learnable_alpha: true
  epsilon: 1.0e-08

  # Interpolation for empty cells (CRITICAL for sensor invariance)
  interpolate_empty: true

  # Quantization
  quantization_bits: 16
  descriptor_size: 220

# Keyframe selection settings
keyframe:
  distance_threshold: 0.8    # More selective
  rotation_threshold: 20.0
  overlap_threshold: 0.65
  temporal_threshold: 7.5
  voxel_size: 0.2
  max_keyframes: 100000

  # Graph settings
  temporal_neighbors: 5
  max_active_nodes: 1000
  freeze_old_embeddings: true

# GNN settings
gnn:
  # Architecture
  input_dim: 50
  hidden_dim: 50
  output_dim: 50
  n_layers: 3
  n_heads: 1
  dropout: 0.1
  residual: true

  # Local updates
  local_update_hops: 3
  use_local_updates: true

  # Training settings
  use_multi_gpu: false
  patience: 10

# Retrieval settings
retrieval:
  # Stage 1: Global retrieval
  top_k: 10
  spatial_filter_distance: 50.0
  context_window: 10
  use_wasserstein: true

  # Stage 2: Geometric verification
  verification_method: gicp
  icp_fitness_threshold: 0.3
  icp_rmse_threshold: 0.5
  icp_max_iterations: 30
  voxel_downsample: 0.3

# System settings
system:
  device: cuda
  num_workers: 4
  seed: 42
  output_dir: outputs
  log_dir: logs
  checkpoint_dir: checkpoints

# Logging settings
logging:
  use_wandb: false
  wandb_project: neural-spectral-codec-helipr
  wandb_entity: null
  log_interval: 10
  save_interval: 1000

# Training settings
training:
  n_epochs: 50
  learning_rate: 5.0e-04
  weight_decay: 1.0e-05
  margin: 0.1
  log_interval: 10

# Triplet mining settings
triplet:
  positive_distance_max: 5.0
  negative_distance_min: 10.0
  negative_distance_max: 50.0
  min_temporal_distance: 30
  n_triplets_per_anchor: 1
