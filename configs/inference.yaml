# Inference Configuration for Neural Spectral Codec

# Inherits from default.yaml and overrides/adds inference-specific parameters

# Model loading
model:
  checkpoint_path: "checkpoints/best_model.pth"  # Path to trained model
  use_quantized: true  # Use quantized descriptors (220 bytes)
  freeze_encoder: true  # Freeze encoder (no gradient computation)

# Deployment settings
deployment:
  mode: "online"  # Mode: online (incremental) or offline (batch)
  real_time: true  # Real-time processing constraints
  max_latency_ms: 100  # Maximum acceptable latency per query

  # Online mode specific
  keyframe_rate_hz: 1.0  # Target keyframe rate (1Hz)
  loop_closing_interval: 10  # Run loop closing every N frames

  # Offline mode specific
  batch_size: 100  # Batch size for offline processing
  use_gpu: true  # Use GPU for batch processing

# Database settings
database:
  storage_format: "binary"  # Storage format (binary, hdf5)
  storage_path: "data/descriptors.bin"  # Path to descriptor database
  max_database_size: 100000  # Maximum number of descriptors
  lazy_loading: true  # Lazy load point clouds (store hashes only)

  # Indexing
  use_indexing: false  # Use indexing for faster retrieval (future: FAISS)
  index_type: null  # Index type (future enhancement)

# Loop closing settings
loop_closing:
  enabled: true  # Enable loop closing
  min_loop_distance: 50.0  # Minimum distance for loop closure (meters)
  max_loop_distance: 200.0  # Maximum distance for loop closure (meters)
  temporal_consistency: 3  # Require N consecutive detections for loop

  # Output format
  output_format: "g2o"  # Output format (g2o, tum, kitti)
  output_path: "outputs/loop_closures.g2o"  # Output file path

  # Information matrix for g2o
  information_matrix:
    translation: [100.0, 100.0, 100.0]  # Information for [x, y, z]
    rotation: [1000.0, 1000.0, 1000.0]  # Information for [roll, pitch, yaw]

# Retrieval optimization
retrieval:
  # Override defaults for inference
  top_k: 10  # Number of candidates
  early_stopping: true  # Stop ICP early if fitness is too low
  parallel_verification: true  # Verify top-K candidates in parallel

  # Caching
  cache_descriptors: true  # Cache descriptors in memory
  cache_embeddings: false  # Don't cache embeddings (save memory)

# Performance monitoring
monitoring:
  enabled: true  # Enable performance monitoring
  log_interval: 100  # Log every N frames
  metrics:
    - "encoding_time"  # Time to encode single scan
    - "query_time"  # Time to query database
    - "icp_time"  # Time for ICP verification
    - "total_time"  # Total time per frame
    - "memory_usage"  # Memory usage
    - "database_size"  # Current database size

# Visualization
visualization:
  enabled: false  # Enable visualization (slows down real-time)
  show_matches: true  # Show loop closure matches
  save_images: false  # Save visualization images
  output_dir: "outputs/visualizations"

# Resource constraints
resources:
  max_memory_gb: 8.0  # Maximum memory usage in GB
  cpu_threads: 4  # Number of CPU threads for ICP
  gpu_memory_fraction: 0.5  # Fraction of GPU memory to use

# ROS integration (optional)
ros:
  enabled: false  # Enable ROS integration
  node_name: "neural_spectral_codec"
  input_topic: "/velodyne_points"  # Input point cloud topic
  output_topic: "/loop_closures"  # Output loop closure topic
  frame_id: "velodyne"  # Frame ID
  publish_rate: 10  # Publishing rate (Hz)

# Quality assurance
quality:
  # Rotation invariance check
  check_rotation_invariance: false  # Test rotation invariance (debug)
  rotation_invariance_threshold: 0.001  # Maximum allowed difference

  # Validation
  validate_descriptors: false  # Validate descriptor integrity
  validate_poses: false  # Validate pose SE(3) properties

# Benchmark settings (for evaluation)
benchmark:
  enabled: false  # Run in benchmark mode
  sequences: [0, 2, 5, 6, 7, 8]  # Sequences to benchmark
  ground_truth_path: "data/kitti/poses"  # Path to ground truth poses
  metrics:
    - "recall@1"
    - "recall@5"
    - "recall@10"
    - "precision@1"
    - "f1@1"
    - "avg_query_time"
    - "avg_icp_time"
  save_results: true  # Save benchmark results
  results_path: "outputs/benchmark_results.json"
